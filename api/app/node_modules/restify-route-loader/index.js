import glob from 'glob';
import { join, parse } from 'path';

let config = {
    supportedVerbs: [ 'get', 'post', 'del', 'put' ]
};
export default function (options) {
    if (typeof options.server === 'undefined') {
        throw 'You must provide a reference to your Restify server';
    }

    Object.assign(config, options);

    const supportedVerbs = config.supportedVerbs.join('|');
    glob(`**/+(${supportedVerbs}).js`, { cwd: config.rootDir }, (err, files) => {
        files.forEach(mountRouteFromFileLocation);
    });
}

function mountRouteFromFileLocation (file) {
    const parsedFile = parse(file);
    const routeMethods = require(join(config.rootDir, file));
    const httpVerb = parsedFile.name;
    const mountPath = parsedFile.dir.replace(new RegExp('/_', 'g'), '/:') || '/';

    config.server[httpVerb](
        {
            path: mountPath
        },
        // [
        //     routeMethods.middleware
        // ],
        routeMethods.default
    );
}
